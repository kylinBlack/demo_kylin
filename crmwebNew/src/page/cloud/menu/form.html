<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<link href="../../../../src/css/common/font-awesome.min.css" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="../../../../src/components/bootstrap3.3.7/css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="../../../../src/css/plug-in/magicsuggest/magicsuggest-min.css">
	<title>form表单</title>
	<style>
		#myModal1 #content_div .dropdown-menu {
			position: relative;
		}

		#myModal1 #content_div .ms-ctn {
			padding: 0;
		}

		#myModal1 #content_div .ms-sel-ctn {
			padding: 8px 20px 8px 14px;
		}

		.col {
			float: left;
		}

		.img-box {
			width: 180px;
			height: 135px;
			overflow: hidden;
			text-align: center;
			position: relative;
			border: 2px solid #DEDEDE;
			line-height: 135px;
		}

		.btn-img-box {
			border: 1px solid #f1f1e3;
			padding-top: 30px;
		}

		.img-box img {
			width: 100%;
			height: 100%;
		}

		.img-box em {
			position: absolute;
			top: 0px;
			right: 5px;
			height: 10px;
			width: 10px;
			text-align: center;
			line-height: 10px;
			color: #f0aaab;
			background-color: rgba(255, 255, 255, 0.4);
			cursor: pointer;
			z-index: 10;
		}

		.shadow-bg {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(255, 255, 255, 0.5);
			z-index: 1;
			font-size: 40px;
			color: #fff;
		}

		.shadow-bg .fa {
			line-height: 135px;
		}


		/*附件*/

		.fujian-wrap {
			border: 1px solid #ccc;
			border-radius: 4px;
			min-height: 34px;
		}

		.fujian-wrap .icon-right {
			position: relative;
			display: inline-block;
			height: 30px;
		}

		.fujian-wrap .btn-link {
			font-size: 14px;
			text-decoration: none;
			color: #666 !important;
		}

		.fujian-wrap .fa-close {
			color: #1e5494;
			line-height: 30px;
			cursor: pointer;
			font-size: 12px;
		}

		.fujian-wrap .shadow {
			z-index: 10;
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 30px;
			background-color: rgba(255, 255, 255, 0.5);
		}

		/*图片*/

		.picture-wrap {
			float: left;
			border: 1px solid #ccc;
			border-radius: 4px;
			width: 100%;
			height: auto;
		}

		.img-box {
			width: 120px;
			height: 92px;
			overflow: hidden;
			text-align: center;
			position: relative;
		}

		.add-fj .btn-link {
			color: #08c !important;
		}

		.component {
			margin: unset !important;
			margin-top: 10px;
			border: 1px solid #fff;
			min-height: 60px;
		}

		.component .component-border {
			float: left;
			width: 100%;
			border: 1px solid #ccc;
			border-radius: 4px;
		}

		.component .inline {
			float: left;
		}

		.component .checkbox,
		.radio {
			padding: 0px;
			padding-top: 0px !important;
			margin-left: 8px;
			margin-right: 25px;
			line-height: 32px;
		}

		.component input[type=checkbox],
		input[type=radio] {
			margin-top: 10px;
		}

		/*分线栏*/

		.item-title {
			height: 30px;
			line-height: 30px;
			color: #428bca;
		}

		.item-title-info {
			display: inline-block;
			cursor: pointer;
		}
	</style>
</head>

<body class="body-padding-top" style="background: #fff;">
	<div>
		<span class="set-table-btn" style="position: absolute;display:none;" onclick="javascript:openFormViewSetting();"></span>
		<!--<div  <c:if test="${sys.modelSettingObj!=null && sys.modelSettingObj.disableCopy!=null &&  sys.modelSettingObj.disableCopy=='1'}">  onselectstart="return false" oncut="return false;"  ondragstart="return false;"  </c:if> class="modal-body" style="overflow-y: auto;overflow-x: hidden;position: absolute;left: 0px;right: 0px;bottom: 110px;top: 10px;">
				<form  id="field_content" method="post" class="form-horizontal" data-bv-message="This value is not valid" data-bv-feedbackicons-valid="glyphicon glyphicon-ok" data-bv-feedbackicons-invalid="glyphicon glyphicon-remove" data-bv-feedbackicons-validating="glyphicon glyphicon-refresh">
				</form>
			</div>-->
		<div class="modal-body" style="overflow-y: auto;overflow-x: hidden;position: absolute;left: 0px;right: 0px;bottom: 110px;top: 10px;">
			<form id="field_content" method="post" class="form-horizontal" data-bv-message="This value is not valid" data-bv-feedbackicons-valid="glyphicon glyphicon-ok"
			    data-bv-feedbackicons-invalid="glyphicon glyphicon-remove" data-bv-feedbackicons-validating="glyphicon glyphicon-refresh">
			</form>
		</div>
		<div class="modal-footer" style="position:absolute;bottom: 45px;right: 10px;width: 100%;">
			<button type="button" id="open_form_btn_submit" class="btn btn-primary" onclick="javascript:submitForm();"><span class="glyphicon glyphicon-floppy-disk"></span>保存</button>
			<button type="button" class="btn btn-default" data-dismiss="modal" onclick="javascript:window.parent.cloudOpenWindow(false);"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span>关闭</button>
		</div>
	</div>
	<!-- 右侧隐藏面板 -->
	<div class="right-wrap new-right-wrap before-right-wrap" id="config_btn_panel" style="z-index: 101;">
	</div>
</body>
#include("../../components/common.html")
<script src="../../../../src/scripts/js/cloud/menu/index_common.js"></script>
<script src="../../../../src/scripts/js/jquery/jquery-2.0.3.min.js"></script>
<script src="../../../../src/scripts/js/jquery/bootstrap.min.js"></script>
<script src="../../../../src/scripts/js/jquery/magicsuggest-min.js"></script>
<script src="../../../../src/scripts/js/plug-in/laydate/laydate.js"></script>
<script src="../../../../src/scripts/js/jquery/bootstrapValidator.js"></script>
<script src="../../../../src/scripts/js/plug-in/layer/layer.js"></script>
<script src="../../../../src/scripts/js/cloud/menu/button_form.js"></script>
<script>
	// var params = getStorgeValue("to_params_value");
	// var y_params_value = getStorgeValue("y_params_value");
	var params = localStorage.getItem("to_params_value");
	var y_params_value = localStorage.getItem("y_params_value");
	if (params) {
		params = JSON.parse(params);
	} else {
		params = {};
	}
	if (y_params_value) {
		y_params_value = JSON.parse(y_params_value);
	}

	var urlParams = getUrlParams(); //url传递的参数
	var sysParams = {}; //系统变量
	var uniqueCheckSetting = {};
	$(function () {
		formId = urlParams.formId;
		if (formId) {
			//获取用户设置的表单显示视图设置信息
			var showFieldList;
			$.ajax({
				url: ctx + "/cloud/userUiConfig/getConfig",
				type: "get",
				async: false,
				data: {
					tableId: formId,
					type: "FORM_VIEW_SETTING"
				},
				success: function (json) {
					if (json.result == "Success" || json.result == "SUCCESS") {
						if (json.map && json.map.setting) {
							var setting = JSON.parse(json.map.setting);
							showFieldList = setting.showFields;
						}
					} else {
						tipsMsg(json.resultMsg, "FAIL");
					}
				}
			});
			$.ajax({
				type: "post",
				url: ctx + "/cloud/form/handler/getForm/obj",
				data: {
					formId: formId
				},
				success: function (json) {
					if (json.result == "Success" || json.result == "SUCCESS") {
						sysParams = JSON.parse(json.map.sys_db);
						if (sysParams.userType == "orgAdmin") {
							$(".set-table-btn").show();
						} else {
							$(".set-table-btn").remove();
						}
						var formObj = json.map.obj;
						var setting = JSON.parse(formObj.setting);
						var sqlSaveId = setting.sqlSaveId;
						var formFieldList = setting.formFieldList;
						uniqueCheckSetting = setting.uniqueCheckSetting;
						var fieldConfigObj = {};
						if (formFieldList && formFieldList.length > 0) {
							if (showFieldList) { //用户设置了表单显示视图
								var allFieldList = {};
								$.each(formFieldList, function (i, obj) {
									fieldConfigObj[obj.name] = obj;
									allFieldList[obj.val_key] = obj;
								});
								$.each(showFieldList, function (i, obj) { //遍历所有显示视图字段
									var field = allFieldList[obj.val_key];
									if (obj.html_type == "LINEBAR") { //分线栏直接以显示视图设置为准
										field = obj;
									} else { //替换显示视图的名称，宽度，是否必填
										field.alias = obj.name;
										field.elem_width = obj.elem_width;
										if (field.is_null == "1") {
											field.is_null = obj.is_null;
										}
									}
									var html = createdFormHtml(field, params, y_params_value);
									if (field.html_type == "LINEBAR" || $("#field_content").find(".item-content-info").length == 0) {
										$("#field_content").append(html);
									} else {
										$("#field_content").find(".item-content-info").last().append(html);
									}
								});
							} else {
								$.each(formFieldList, function (i, obj) {
									fieldConfigObj[obj.name] = obj;
									var html = createdFormHtml(obj, params, y_params_value);
									if (obj.html_type == "LINEBAR" || $("#field_content").find(".item-content-info").length == 0) {
										$("#field_content").append(html);
									} else {
										$("#field_content").find(".item-content-info").last().append(html);
									}
								});
							}
							$("#field_content").append("<div style='display:none;'><input name='mark'></div>")
							$('#field_content').find(".bv-hidden-submit").remove();
							initEvent(fieldConfigObj, uniqueCheckSetting, setting.fieldToggleSetting);
							$('#field_content').bootstrapValidator();
						}
					} else {
						tipsMsg(json.resultMsg, "FAIL");
					}
				},
				error: function (xhr, type) {
					alert('Ajax error!' + xhr + "\t\t" + type)
				}
			});
		} else {
			tipsMsg("表单id不能为空", "FAIL");
		}
	});

	function submitForm() {
		var bootstrapValidator = $("#field_content").data('bootstrapValidator');
		bootstrapValidator.validate();
		if (bootstrapValidator.isValid() && createHtml.definedValidate("field_content")) {
			if ($.isEmptyObject(uniqueCheckSetting) || createHtml.uniqueCheck(uniqueCheckSetting, sysParams, getTableData()) ==
				"SUCCESS") {
				submit();
			}
		}
	}

	function initEvent(fieldConfigObj, uniqueCheckSetting, fieldToggleSetting) {
		var content_div = $("#field_content");
		content_div.find("input[type=file]").each(function (i, obj) {
			var obj = $(obj);
			var value = obj.attr("url_value");
			if (obj.attr("upType") == "file") {
				initUPFile(obj, value);
			} else {
				initUPPic(obj, value);
			}
		});
		content_div.find("input[db_type=date]").each(function (i, obj) {
			createHtml.init_obj.initDate(obj);
		});
		content_div.find("input[htmlType=SEARCH_MORE]").each(function (i, obj) {
			obj = $(obj);
			var name = obj.attr("key_name");
			var valueKey = obj.attr("valueKey");
			if (name && fieldConfigObj[name] && fieldConfigObj[name].wordbook && fieldConfigObj[name].wordbook.id &&
				fieldConfigObj[name].wordbook.value_key) {
				var wordbook = fieldConfigObj[name].wordbook;
				var id = wordbook.id;
				//过滤条件、参与搜索字段、兼容列表搜素
				var params = {
					wordbookType: wordbook.type,
					fieldKeys: JSON.stringify(wordbook.search_key),
					type: 1
				};
				if (wordbook.conObj) {
					params.conObj = wordbook.conObj;
					params.sqlExpression = wordbook.sqlExpression;

				}
				//新增按钮
				var addButton;
				if (wordbook.add_btn) {
					addButton = JSON.parse(wordbook.add_btn);
					obj.parent().append('<input type="button" class="btn btn-sm btn-warning addBtnIfNull" value="去新增" key_id="' +
						addButton.sid + '" style="position: absolute;top:2px;right:17px;display:none;">');
					obj.parent().on("click", ".addBtnIfNull", function () {
						var key_id = $(this).attr("key_id");
						var buttonConfigList = {};
						buttonConfigList[key_id] = addButton;
						var data = {
							table: getTableData(),
							sys: sysParams,
							form: urlParams
						};
						var input = $(this).parent().find(".ms-ctn").find("input[type=text]");
						btf.button.clickButton(this, buttonConfigList, data, function () {
							input.val(custEnterWord).click();
						});
					});
				}
				//取值字段
				var value_key = wordbook.value_key;
				var valueList = [];
				if (valueKey) {
					var defObj = {};
					defObj[value_key] = valueKey;
					valueList = [defObj];
				}
				//obj.parent().append('<input class="form-control" key="extend_element"  type="hidden" key_name="'+name+'" name="'+obj.attr("key_id")+'" htmlType="SEARCH_MORE">');
				obj.parent().append($(obj.clone()).css("display", "none"));
				//下拉显示字段
				var renderKeyList = [value_key];
				if (wordbook.render_key && wordbook.render_key.length > 0) {
					renderKeyList = wordbook.render_key;
				}
				var obEv = obj.magicSuggest({
					data: ctx + "/cloud/table/list/reader/wordbook/" + id,
					getParams: function () {
						return params;
					},
					value: valueList,
					allowFreeEntries: false,
					valueField: value_key,
					placeholder: "请选择",
					noSuggestionText: "<font color='#a94442'>未检索到数据</font>",
					displayField: value_key, //定义显示的字段
					maxSelectionRenderer: function () {
						return "";
					},
					selectionRenderer: function (data) {
						var newData = {};
						for (var da in data) {
							newData[da] = data[da];
						}
						return "<label style='display:none;'>" + JSON.stringify(newData) + "</label>" + data[value_key];
					},
					renderer: function (data) {
						var text = "";
						for (var i = 0; i < renderKeyList.length; i++) {
							if (data[renderKeyList[i]]) {
								text += data[renderKeyList[i]] + "&nbsp;&nbsp;&nbsp;&nbsp;";
							}
						}
						return text;
					}
				});
				//是否显示新增按钮
				var custEnterWord;
				$(obEv).on("load", function (e, m, records) {
					var addBtn = $("input[key_name='" + name + "']").parent().find(".addBtnIfNull111");
					if (addBtn && addBtn.length > 0) {
						if (records.length == 0) {
							custEnterWord = obEv.getRawValue();
							addBtn.show();
						} else {
							addBtn.hide();
						}
					}
				});
			}
		});
		content_div.find("input[htmlType=SEARCH_SELECT]").each(function (i, obj) {
			obj = $(obj);
			var name = obj.attr("key_name");
			var valueKey = obj.attr("valueKey");
			if (name && fieldConfigObj[name] && fieldConfigObj[name].wordbook && fieldConfigObj[name].wordbook.id &&
				fieldConfigObj[name].wordbook.value_key) {
				var config = fieldConfigObj[name];
				var wordbook = config.wordbook;
				var id = wordbook.id;
				//过滤条件、参与搜索字段、兼容列表搜素
				var params = {
					wordbookType: wordbook.type,
					fieldKeys: JSON.stringify(wordbook.search_key),
					type: 1
				};
				if (wordbook.conObj) {
					params.conObj = wordbook.conObj;
					params.sqlExpression = wordbook.sqlExpression;

				}
				//新增按钮
				var addButton;
				if (wordbook.add_btn) {
					addButton = JSON.parse(wordbook.add_btn);
					obj.parent().append('<input type="button" class="btn btn-sm btn-warning addBtnIfNull" value="去新增" key_id="' +
						addButton.sid + '" style="position: absolute;top:2px;right:17px;display:none;">');
					obj.parent().on("click", ".addBtnIfNull", function () {
						var key_id = $(this).attr("key_id");
						var buttonConfigList = {};
						buttonConfigList[key_id] = addButton;
						var data = {
							table: getTableData(),
							sys: sysParams,
							form: urlParams
						};
						var input = $(this).parent().find(".ms-ctn").find("input[type=text]");
						btf.button.clickButton(this, buttonConfigList, data, function () {
							input.val(custEnterWord).click();
						});
					});
				}
				//取值字段
				var value_key = wordbook.value_key;
				var valueList = [];
				if (valueKey) {
					var defObj = {};
					defObj[value_key] = valueKey;
					valueList = [defObj];
				}
				//obj.parent().append('<input class="form-control" key="extend_element"  type="hidden" key_name="'+name+'" name="'+obj.attr("key_id")+'">');
				obj.parent().append($(obj.clone()).css("display", "none"));
				//下拉显示字段
				var renderKeyList = [value_key];
				if (wordbook.render_key && wordbook.render_key.length > 0) {
					renderKeyList = wordbook.render_key;
				}
				var obEv = obj.magicSuggest({
					data: ctx + "/cloud/table/list/reader/wordbook/" + id,
					getParams: function () {
						return params;
					},
					value: valueList,
					allowFreeEntries: false,
					valueField: value_key,
					maxSelection: 1, //设置选择个数
					placeholder: "请选择",
					noSuggestionText: "<font color='#a94442'>未检索到数据</font>",
					displayField: value_key, //定义显示的字段
					maxSelectionRenderer: function () {
						return "";
					},
					selectionRenderer: function (data) {
						createHtml.jlChangBak(wordbook, data);
						var value = data[value_key];
						$("input[key_name='" + name + "']").val(value);
						createHtml.validateSelect($($("input[key_name='" + name + "']")[0]));
						return value;
					},
					renderer: function (data) {
						var text = "";
						for (var i = 0; i < renderKeyList.length; i++) {
							if (data[renderKeyList[i]]) {
								text += data[renderKeyList[i]] + "&nbsp;&nbsp;&nbsp;&nbsp;";
							}
						}
						return text;
					}
				});
				$(obEv).on('selectionchange', function (e, m, records) {
					if (records.length == 0) {
						$("input[key_name='" + name + "']").val("");
						createHtml.validateSelect($($("input[key_name='" + name + "']")[0]));
						createHtml.jlChangClean(wordbook);
					} else {
						//绑定去重校验、字段显示隐藏事件[搜索]
						if (config.validate && config.validate.event_obj) {
							if (config.validate.event_obj == "field_toggle") {
								createHtml.fieldToggle(fieldToggleSetting, sysParams, getTableData());
							} else if (config.validate.event_obj == "unique_check") {
								if (createHtml.uniqueCheck(uniqueCheckSetting, sysParams, getTableData()) == "SUCCESS") {
									tipsMsg("恭喜，去重校验通过！", "SUCCESS");
								}
							}
						}
					}
				});
				//是否显示新增按钮
				var custEnterWord;
				$(obEv).on("load", function (e, m, records) {
					var addBtn = $("input[key_name='" + name + "']").parent().find(".addBtnIfNull");
					if (addBtn && addBtn.length > 0) {
						if (records.length == 0) {
							custEnterWord = obEv.getRawValue();
							addBtn.show();
						} else {
							addBtn.hide();
						}
					}
				});
			}
		});
		//绑定去重校验、字段显示隐藏事件[文本，下拉]
		content_div.find("input[event_obj=field_toggle],input[event_obj=unique_check]").on("blur", function () {
			if ($(this).attr("event_obj") == "field_toggle") {
				createHtml.fieldToggle(fieldToggleSetting, sysParams, getTableData());
			} else if ($(this).attr("event_obj") == "unique_check") {
				if ($(this).val() && createHtml.uniqueCheck(uniqueCheckSetting, sysParams, getTableData()) == "SUCCESS") {
					tipsMsg("恭喜，去重校验通过！", "SUCCESS");
				}
			}
		});
		content_div.find("select[event_obj=field_toggle],select[event_obj=unique_check]").on("change", function () {
			if ($(this).attr("event_obj") == "field_toggle") {
				createHtml.fieldToggle(fieldToggleSetting, sysParams, getTableData());
			} else if ($(this).attr("event_obj") == "unique_check") {
				if ($(this).val() && createHtml.uniqueCheck(uniqueCheckSetting, sysParams, getTableData()) == "SUCCESS") {
					tipsMsg("恭喜，去重校验通过！", "SUCCESS");
				}
			}
		});
		//分线栏绑定单击事件
		content_div.find(".item-title-info").on("click", function () {
			$(this).find("i").toggleClass("fa-caret-down fa-caret-right");
			$(this).parents(".component").next().toggle();
		});
		//绑定身份证对象带出出生日期、年龄、性别
		content_div.find("[obj_type=id_card]").on("blur", function () {
			var value = $.trim($(this).val());
			if (value && value.length == 18) {
				var birthday = value.substring(6, 10) + "-" + value.substring(10, 12) + "-" + value.substring(12, 14);
				var sex = (parseInt(value.substr(16, 1)) % 2 == 1) ? "1" : "2";
				var currDate = new Date();
				var birthDate = new Date(birthday);
				var age = currDate.getFullYear() - birthDate.getFullYear();
				//再考虑月、天的因素;.getMonth()获取的是从0开始的，这里进行比较，不需要加1
				if (currDate.getMonth() < birthDate.getMonth() || (currDate.getMonth() == birthDate.getMonth() && currDate.getDate() <
						birthDate.getDate())) {
					age--;
				}
				$("[obj_type=birthday]").val(birthday); //出生日期
				$("[obj_type=age]").val(age); //年龄
				$("[obj_type=sex]").each(function () { //性别
					if ($(this).prop("type") == "radio") {
						$(this).prop("checked", $(this).val() == sex);
					} else {
						$(this).val(sex);
					}
				});
			}
		});
	}

	function createdFormHtml(ffobj, params, y_params_value) {
		var html_type = ffobj.html_type;
		var name = ffobj.name;
		var is_show = ffobj.is_show;
		var is_null = ffobj.is_null;
		var is_edit = ffobj.is_edit;
		var val_key = ffobj.val_key;
		var elem_width = ffobj.elem_width;
		var disabled_str = "";
		var isbt = "Y";
		var options = getOptions(ffobj);
		var validateObj = getValidateObj(ffobj);
		if (is_show && is_show == "0") {
			disabled_str = "style='display:none;'";
		}
		if (is_edit && is_edit == "0") {
			disabled_str += " disabled "
		}
		if (is_null && is_null == "1") {
			isbt = "N";
		}
		if (!val_key) {
			val_key = "";
		}
		if (!elem_width) {
			elem_width = 12;
		}
		var defaultValue = params[name];
		if (!defaultValue) {
			if (ffobj.default_val) {
				defaultValue = ffobj.default_val;
				defaultValue = btf.parseTFSParams(defaultValue, {
					sys: sysParams
				});
			} else {
				defaultValue = "";
			}
		}
		var alias = ffobj.alias; //别名，表单显示视图中设置
		if (!alias) {
			alias = name;
		}
		if ("INPUT" == html_type) {
			return createHtml.input(name, alias, val_key, defaultValue, elem_width, disabled_str, validateObj, isbt);
		} else if ("TEXTAREA" == html_type) {
			return createHtml.textArea(name, alias, val_key, defaultValue, elem_width, disabled_str, validateObj, isbt);
		} else if ("DATE-INPUT" == html_type) {
			return createHtml.date_input(name, alias, val_key, defaultValue, elem_width, disabled_str, validateObj, isbt,
				y_params_value);
		} else if ("DATETIME-INPUT" == html_type) {
			return createHtml.datetime_input(name, alias, val_key, defaultValue, elem_width, disabled_str, validateObj, isbt,
				y_params_value);
		} else if ("TIME-INPUT" == html_type) {
			return createHtml.time_input(name, alias, val_key, defaultValue, elem_width, disabled_str, validateObj, isbt,
				y_params_value);
		} else if ("DATE" == html_type) {
			var date_format = ffobj.date_format;
			return createHtml.date(name, alias, val_key, defaultValue, elem_width, disabled_str, validateObj, isbt,
				y_params_value, date_format);
		} else if ("SELECT" == html_type) {
			return createHtml.select(name, alias, val_key, defaultValue, elem_width, disabled_str, options, validateObj, isbt);
		} else if ("CHECKBOX" == html_type) {
			return createHtml.checkbox(name, alias, val_key, defaultValue, elem_width, disabled_str, options, isbt);
		} else if ("CHECKBOX_BLOCK" == html_type) {
			return createHtml.checkboxBlock(name, alias, val_key, defaultValue, elem_width, disabled_str, options, isbt);
		} else if ("RADIO" == html_type) {
			return createHtml.redio(name, alias, val_key, defaultValue, elem_width, disabled_str, options, validateObj, isbt);
		} else if ("RADIO_BLOCK" == html_type) {
			return createHtml.redioBlock(name, alias, val_key, defaultValue, elem_width, disabled_str, options, validateObj,
				isbt);
		} else if ("SEARCH" == html_type && ffobj.wordbook) {
			return createHtml.searchSelect(name, alias, val_key, defaultValue, elem_width, disabled_str, isbt);
		} else if ("SEARCH_MORE" == html_type && ffobj.wordbook) {
			return createHtml.searchMore(name, alias, val_key, defaultValue, elem_width, disabled_str, isbt);
		} else if ("UPPICTURE" == html_type) {
			return createHtml.uppicture(name, alias, val_key, defaultValue, elem_width, disabled_str);
		} else if ("UPFILE" == html_type) {
			return createHtml.upfile(name, alias, val_key, defaultValue, elem_width, disabled_str);
		} else if ("LINEBAR" == html_type) {
			return createHtml.lineBar(name, alias, disabled_str);
		} else if ("DIGITAL" == html_type) {
			return createHtml.digital(name, alias, val_key, defaultValue, elem_width, disabled_str, validateObj, isbt);
		}
	}

	function getOptions(ffObj) {
		var options = [];
		if (ffObj.option) {
			for (var o in ffObj.option) {
				options.push({
					valueName: o,
					format: ffObj.option[o]
				});
			}
		}
		return options;
	}

	function getValidateObj(ffObj) {
		if (ffObj.validate) {
			var vO = {};
			if (ffObj.validate.vali_obj) {
				vO.validate = ffObj.validate.vali_obj;
			}
			if (ffObj.validate.min_length) {
				vO.minlength = ffObj.validate.min_length;
			}
			if (ffObj.validate.max_length) {
				vO.maxlength = ffObj.validate.max_length;
			}
			if (ffObj.validate.min_date) {
				vO.minDate = ffObj.validate.min_date;
			}
			if (ffObj.validate.max_date) {
				vO.maxDate = ffObj.validate.max_date;
			}
			if (ffObj.validate.min_value) {
				vO.minValue = ffObj.validate.min_value;
			}
			if (ffObj.validate.max_value) {
				vO.maxValue = ffObj.validate.max_value;
			}
			if (ffObj.validate.decimal_length) {
				vO.decimalLength = ffObj.validate.decimal_length;
			}
			if (ffObj.validate.event_obj) {
				vO.eventObj = ffObj.validate.event_obj;
			}
			if (ffObj.validate.obj_type) {
				vO.objType = ffObj.validate.obj_type;
			}
			return vO;
		}
	}

	function getTableData() {
		var divObj = $("#field_content");

		function getVlaueByName(divOjb, name) {
			var nameArray = divOjb.find("[name='" + name + "']");
			var data = [];
			for (var i = 0; i < nameArray.length; i++) {
				if (nameArray[i].checked == true) {
					data.push($.trim($(nameArray[i]).val()));
				}
			}
			return data;
		}
		var eea = divObj.find("[key='extend_element']");
		var names = "";
		var db = {};
		for (var i = 0; i < eea.length; i++) {
			var io = $(eea[i]);
			var name = $.trim(io.attr("name"));
			if (name) {
				var type = $.trim(io.attr("type"));
				if ("radio" == type || "checkbox" == type) {
					if (!(names.indexOf(name) != -1)) {
						names = names + "|" + name;
						var objVal = getVlaueByName(divObj, name);
						if (objVal.length > 0) {
							objVal = objVal.join(",");
						}
						db[name] = objVal;
					}
				} else if ("file" == type) {
					var keyName = io.attr("key_name");
					if (io.attr("upType") == "file") {
						var imgDiv = io.parent();
						var fileList = [];
						imgDiv.find("input[key='url']").each(function (i, obj) {
							obj = $(obj);
							var value = obj.val();
							if (value) {
								var fn = obj.attr("name");
								var fsize = obj.attr("size");
								fileList.push({
									url: value,
									name: fn,
									size: fsize
								});
							}
						});
						if (fileList.length > 0) {
							db[keyName] = JSON.stringify(fileList);
						}
					} else {
						var imgDiv = io.parent();
						var urls = "";
						imgDiv.find("input[key='url']").each(function (i, obj) {
							obj = $(obj);
							var url = $.trim(obj.val());
							if (url) {
								if (urls) {
									urls += "," + url;
								} else {
									urls = url;
								}
							}
						});
						db[keyName] = urls;
					}
				} else {
					if (io.attr("htmlType") == "SEARCH_MORE") {
						var moreObj = [];
						io.parent().find(".ms-sel-item label").each(function (i, obj) {
							var htmlStr = $.trim($(obj).html());
							moreObj.push(JSON.parse(htmlStr));
						});
						db[name] = JSON.stringify(moreObj);
					} else {
						var value = $.trim(io.val());
						if (value && (value.indexOf("<div>") != -1 || value.indexOf("<#if") != -1)) {
							value = encodeURIComponent(value);
						}
						db[name] = value;
					}
				}
				//表单验证
				if (io.siblings(".redRequired").length != 0 && io.attr("type") != "hidden" &&
					(db[name] == "" || db[name] == null)) {
					Notify(io.attr("placeholder") + ":不能空或null值.", 'top-right', '500', 'danger', 'fa-bolt', true);
					return;
				}
			}
		}
		return db;
	}

	function submit() {
		var db = getTableData();
		db['formId'] = formId;

		var loadMsg = layer.msg("正在加载...", {
			icon: 16,
			shade: [0.1, '#393D49'],
			time: 60000
		});
		var saveUrl = ctx + "/cloud/form/handler/saveForm";
		$.post(saveUrl, db, function (json) {
			layer.close(loadMsg);
			if (json.result == "SUCCESS") {
				var resultObj;
				if (json.map && json.map.result) {
					if (json.map.result.indexOf("[[") != -1) {
						resultObj = json.map.result.replace("[[", "{").replace("]]", "}");
						resultObj = JSON.parse(resultObj);
					}
				}
				if (resultObj && resultObj.message) {
					window.parent.tipsMsg(resultObj.message, "SUCCESS");
				} else {
					window.parent.tipsMsg("保存成功", "SUCCESS");
				}
				window.parent.cloudOpenWindow(true);
			} else {
				tipsMsg(json.resultMsg, "FAIL");
			}
		});
	}

	//打开表单显示视图设置界面
	function openFormViewSetting() {
		// var url = '${ctx}/new/menu/formSetting.jsp?formId=' + urlParams.formId;

		var url = './formSetting.html?formId=' + urlParams.formId;
		// var url = './formSetting.html?formId=1090798972114571264';
		
		openWindow(url, function () {
			window.location.reload();
		});
	}
</script>
<script type="application/javascript">
	var openWindowMarker = false;

	function openWindow(url, bakFun) {
		openWindowMarker = true;
		window.openWindowBanFun = bakFun;
		$("#config_btn_panel").css({
			"width": "1100px",
			"right": "0px"
		});
		$("#config_btn_panel").html(
			'<div class="clearfix head-line"><em class="back-btn" onclick="javascript:cloudOpenWindow();"></em></div><iframe width="100%" height="100%" scrolling="no" frameborder="0" src="' +
			url + '"></iframe>');
		$('#config_btn_panel').addClass('right-wrap-show animated fadeInRight');
	}

	function cloudOpenWindow(isSuccess) {
		openWindowMarker = false;
		$("#config_btn_panel").removeClass("right-wrap-show fadeInRight");
		$("#config_btn_panel").animate({
			"right": "-1100px",
			"opacity": "0.7"
		}, 600);
		$("#config_btn_panel").empty();
		if (isSuccess) {
			if (window.openWindowBanFun) {
				window.openWindowBanFun();
			}
		}
	}
</script>

</html>